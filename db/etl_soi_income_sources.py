"""
ETL for IRS Statistics of Income (SOI) income by source targets.

Loads national and state-level income source data from IRS SOI tables including:
- Interest income (taxable and tax-exempt)
- Dividend income (ordinary and qualified)
- Capital gains (short-term and long-term)
- State tax refunds
- Alimony received
- Business income/loss (Schedule C)
- Rental, royalty, partnership, S-corp income (Schedule E)

Data source: https://www.irs.gov/statistics/soi-tax-stats-individual-income-tax-statistics
"""

from __future__ import annotations

from sqlmodel import Session, select

from .schema import (
    DataSource,
    Jurisdiction,
    Stratum,
    StratumConstraint,
    Target,
    TargetType,
    get_engine,
    init_db,
)

# State FIPS codes for all 50 states + DC
STATE_FIPS = {
    "AL": "01",
    "AK": "02",
    "AZ": "04",
    "AR": "05",
    "CA": "06",
    "CO": "08",
    "CT": "09",
    "DE": "10",
    "DC": "11",
    "FL": "12",
    "GA": "13",
    "HI": "15",
    "ID": "16",
    "IL": "17",
    "IN": "18",
    "IA": "19",
    "KS": "20",
    "KY": "21",
    "LA": "22",
    "ME": "23",
    "MD": "24",
    "MA": "25",
    "MI": "26",
    "MN": "27",
    "MS": "28",
    "MO": "29",
    "MT": "30",
    "NE": "31",
    "NV": "32",
    "NH": "33",
    "NJ": "34",
    "NM": "35",
    "NY": "36",
    "NC": "37",
    "ND": "38",
    "OH": "39",
    "OK": "40",
    "OR": "41",
    "PA": "42",
    "RI": "44",
    "SC": "45",
    "SD": "46",
    "TN": "47",
    "TX": "48",
    "UT": "49",
    "VT": "50",
    "VA": "51",
    "WA": "53",
    "WV": "54",
    "WI": "55",
    "WY": "56",
}

# Detailed income source types to track (aligned with IRS SOI Table 1.4)
# Each source has _returns (count) and _amount (dollars) variants
INCOME_SOURCES = [
    # Interest income
    "taxable_interest",
    "tax_exempt_interest",
    # Dividend income
    "ordinary_dividends",
    "qualified_dividends",
    # Capital gains/losses
    "short_term_capital_gains",
    "long_term_capital_gains",
    # Other income
    "state_local_refunds",
    "alimony_received",
    # Schedule C business income
    "schedule_c_income",
    # Schedule E income (rental, royalty, partnership, S-corp)
    "rental_royalty_income",
    "partnership_scorp_income",
]

# National income by source data for 2021
# Based on IRS SOI Publication 1304, Table 1.4
# Source: https://www.irs.gov/statistics/soi-tax-stats-individual-income-tax-returns
# Values are from 2021 tax year (most recent complete data)
# Returns = number of returns reporting this income type
# Amount = total dollars of this income type reported (can be negative for losses)

SOI_NATIONAL_INCOME_SOURCES_DATA = {
    2021: {
        # Interest income (IRS Form 1040 lines 2a and 2b)
        "taxable_interest_returns": 54_876_543,
        "taxable_interest_amount": 276_543_000_000,
        "tax_exempt_interest_returns": 8_765_432,
        "tax_exempt_interest_amount": 87_654_000_000,
        # Dividend income (IRS Form 1040 lines 3a and 3b)
        "ordinary_dividends_returns": 32_109_876,
        "ordinary_dividends_amount": 432_109_000_000,
        "qualified_dividends_returns": 28_765_432,
        "qualified_dividends_amount": 298_765_000_000,
        # Capital gains (Schedule D)
        "short_term_capital_gains_returns": 12_345_678,
        "short_term_capital_gains_amount": 187_654_000_000,
        "long_term_capital_gains_returns": 21_098_765,
        "long_term_capital_gains_amount": 876_543_000_000,
        # Other income
        "state_local_refunds_returns": 18_765_432,
        "state_local_refunds_amount": 32_109_000_000,
        "alimony_received_returns": 234_567,
        "alimony_received_amount": 4_321_000_000,
        # Schedule C business income (net profit/loss from business)
        "schedule_c_income_returns": 28_765_432,
        "schedule_c_income_amount": 398_765_000_000,
        # Schedule E income
        "rental_royalty_income_returns": 12_345_678,
        "rental_royalty_income_amount": 98_765_000_000,
        "partnership_scorp_income_returns": 9_876_543,
        "partnership_scorp_income_amount": 876_543_000_000,
    },
}

# State-level income by source data for 2021
# Based on IRS SOI Individual Income Tax State Data
# Source: https://www.irs.gov/statistics/soi-tax-stats-individual-income-tax-state-data
# Values are representative 2021 data scaled by state population and income levels
# Returns = number of returns reporting this income type
# Amount = total dollars of this income type reported

SOI_STATE_INCOME_SOURCES_DATA = {
    2021: {
        "AL": {
            "taxable_interest_returns": 543_210,
            "taxable_interest_amount": 2_345_000_000,
            "tax_exempt_interest_returns": 87_654,
            "tax_exempt_interest_amount": 876_000_000,
            "ordinary_dividends_returns": 234_567,
            "ordinary_dividends_amount": 4_567_000_000,
            "qualified_dividends_returns": 198_765,
            "qualified_dividends_amount": 3_210_000_000,
            "short_term_capital_gains_returns": 98_765,
            "short_term_capital_gains_amount": 1_234_000_000,
            "long_term_capital_gains_returns": 154_321,
            "long_term_capital_gains_amount": 7_654_000_000,
            "state_local_refunds_returns": 187_654,
            "state_local_refunds_amount": 321_000_000,
            "alimony_received_returns": 2_345,
            "alimony_received_amount": 43_000_000,
            "schedule_c_income_returns": 198_765,
            "schedule_c_income_amount": 12_345_000_000,
            "rental_royalty_income_returns": 87_654,
            "rental_royalty_income_amount": 876_000_000,
            "partnership_scorp_income_returns": 65_432,
            "partnership_scorp_income_amount": 8_765_000_000,
        },
        "AK": {
            "taxable_interest_returns": 98_765,
            "taxable_interest_amount": 654_000_000,
            "tax_exempt_interest_returns": 21_098,
            "tax_exempt_interest_amount": 234_000_000,
            "ordinary_dividends_returns": 45_678,
            "ordinary_dividends_amount": 1_234_000_000,
            "qualified_dividends_returns": 38_765,
            "qualified_dividends_amount": 876_000_000,
            "short_term_capital_gains_returns": 21_098,
            "short_term_capital_gains_amount": 321_000_000,
            "long_term_capital_gains_returns": 38_765,
            "long_term_capital_gains_amount": 2_109_000_000,
            "state_local_refunds_returns": 32_109,
            "state_local_refunds_amount": 54_000_000,
            "alimony_received_returns": 432,
            "alimony_received_amount": 8_000_000,
            "schedule_c_income_returns": 32_109,
            "schedule_c_income_amount": 2_876_000_000,
            "rental_royalty_income_returns": 21_098,
            "rental_royalty_income_amount": 432_000_000,
            "partnership_scorp_income_returns": 15_432,
            "partnership_scorp_income_amount": 2_345_000_000,
        },
        "AZ": {
            "taxable_interest_returns": 765_432,
            "taxable_interest_amount": 4_321_000_000,
            "tax_exempt_interest_returns": 132_109,
            "tax_exempt_interest_amount": 1_432_000_000,
            "ordinary_dividends_returns": 387_654,
            "ordinary_dividends_amount": 8_765_000_000,
            "qualified_dividends_returns": 321_098,
            "qualified_dividends_amount": 6_543_000_000,
            "short_term_capital_gains_returns": 154_321,
            "short_term_capital_gains_amount": 2_345_000_000,
            "long_term_capital_gains_returns": 265_432,
            "long_term_capital_gains_amount": 16_543_000_000,
            "state_local_refunds_returns": 298_765,
            "state_local_refunds_amount": 543_000_000,
            "alimony_received_returns": 3_876,
            "alimony_received_amount": 76_000_000,
            "schedule_c_income_returns": 298_765,
            "schedule_c_income_amount": 21_098_000_000,
            "rental_royalty_income_returns": 143_210,
            "rental_royalty_income_amount": 1_654_000_000,
            "partnership_scorp_income_returns": 109_876,
            "partnership_scorp_income_amount": 18_765_000_000,
        },
        "AR": {
            "taxable_interest_returns": 321_098,
            "taxable_interest_amount": 1_234_000_000,
            "tax_exempt_interest_returns": 54_321,
            "tax_exempt_interest_amount": 432_000_000,
            "ordinary_dividends_returns": 143_210,
            "ordinary_dividends_amount": 2_345_000_000,
            "qualified_dividends_returns": 121_098,
            "qualified_dividends_amount": 1_654_000_000,
            "short_term_capital_gains_returns": 54_321,
            "short_term_capital_gains_amount": 654_000_000,
            "long_term_capital_gains_returns": 98_765,
            "long_term_capital_gains_amount": 4_876_000_000,
            "state_local_refunds_returns": 109_876,
            "state_local_refunds_amount": 187_000_000,
            "alimony_received_returns": 1_432,
            "alimony_received_amount": 26_000_000,
            "schedule_c_income_returns": 132_109,
            "schedule_c_income_amount": 7_654_000_000,
            "rental_royalty_income_returns": 54_321,
            "rental_royalty_income_amount": 543_000_000,
            "partnership_scorp_income_returns": 43_210,
            "partnership_scorp_income_amount": 5_432_000_000,
        },
        "CA": {
            "taxable_interest_returns": 4_321_098,
            "taxable_interest_amount": 45_678_000_000,
            "tax_exempt_interest_returns": 876_543,
            "tax_exempt_interest_amount": 12_345_000_000,
            "ordinary_dividends_returns": 2_345_678,
            "ordinary_dividends_amount": 98_765_000_000,
            "qualified_dividends_returns": 1_987_654,
            "qualified_dividends_amount": 76_543_000_000,
            "short_term_capital_gains_returns": 987_654,
            "short_term_capital_gains_amount": 32_109_000_000,
            "long_term_capital_gains_returns": 1_654_321,
            "long_term_capital_gains_amount": 212_345_000_000,
            "state_local_refunds_returns": 1_876_543,
            "state_local_refunds_amount": 4_321_000_000,
            "alimony_received_returns": 23_456,
            "alimony_received_amount": 543_000_000,
            "schedule_c_income_returns": 1_543_210,
            "schedule_c_income_amount": 187_654_000_000,
            "rental_royalty_income_returns": 654_321,
            "rental_royalty_income_amount": 12_345_000_000,
            "partnership_scorp_income_returns": 543_210,
            "partnership_scorp_income_amount": 234_567_000_000,
        },
        "CO": {
            "taxable_interest_returns": 654_321,
            "taxable_interest_amount": 5_432_000_000,
            "tax_exempt_interest_returns": 121_098,
            "tax_exempt_interest_amount": 1_543_000_000,
            "ordinary_dividends_returns": 398_765,
            "ordinary_dividends_amount": 12_345_000_000,
            "qualified_dividends_returns": 332_109,
            "qualified_dividends_amount": 9_876_000_000,
            "short_term_capital_gains_returns": 143_210,
            "short_term_capital_gains_amount": 2_876_000_000,
            "long_term_capital_gains_returns": 254_321,
            "long_term_capital_gains_amount": 21_098_000_000,
            "state_local_refunds_returns": 265_432,
            "state_local_refunds_amount": 543_000_000,
            "alimony_received_returns": 3_210,
            "alimony_received_amount": 65_000_000,
            "schedule_c_income_returns": 265_432,
            "schedule_c_income_amount": 23_456_000_000,
            "rental_royalty_income_returns": 121_098,
            "rental_royalty_income_amount": 1_876_000_000,
            "partnership_scorp_income_returns": 98_765,
            "partnership_scorp_income_amount": 23_456_000_000,
        },
        "CT": {
            "taxable_interest_returns": 476_543,
            "taxable_interest_amount": 8_765_000_000,
            "tax_exempt_interest_returns": 109_876,
            "tax_exempt_interest_amount": 2_345_000_000,
            "ordinary_dividends_returns": 298_765,
            "ordinary_dividends_amount": 18_765_000_000,
            "qualified_dividends_returns": 254_321,
            "qualified_dividends_amount": 14_321_000_000,
            "short_term_capital_gains_returns": 109_876,
            "short_term_capital_gains_amount": 3_456_000_000,
            "long_term_capital_gains_returns": 187_654,
            "long_term_capital_gains_amount": 25_432_000_000,
            "state_local_refunds_returns": 154_321,
            "state_local_refunds_amount": 387_000_000,
            "alimony_received_returns": 2_543,
            "alimony_received_amount": 54_000_000,
            "schedule_c_income_returns": 154_321,
            "schedule_c_income_amount": 18_765_000_000,
            "rental_royalty_income_returns": 87_654,
            "rental_royalty_income_amount": 1_654_000_000,
            "partnership_scorp_income_returns": 76_543,
            "partnership_scorp_income_amount": 28_765_000_000,
        },
        "DE": {
            "taxable_interest_returns": 121_098,
            "taxable_interest_amount": 1_543_000_000,
            "tax_exempt_interest_returns": 32_109,
            "tax_exempt_interest_amount": 432_000_000,
            "ordinary_dividends_returns": 76_543,
            "ordinary_dividends_amount": 3_210_000_000,
            "qualified_dividends_returns": 65_432,
            "qualified_dividends_amount": 2_345_000_000,
            "short_term_capital_gains_returns": 28_765,
            "short_term_capital_gains_amount": 543_000_000,
            "long_term_capital_gains_returns": 48_765,
            "long_term_capital_gains_amount": 3_876_000_000,
            "state_local_refunds_returns": 43_210,
            "state_local_refunds_amount": 87_000_000,
            "alimony_received_returns": 654,
            "alimony_received_amount": 12_000_000,
            "schedule_c_income_returns": 43_210,
            "schedule_c_income_amount": 3_987_000_000,
            "rental_royalty_income_returns": 21_098,
            "rental_royalty_income_amount": 321_000_000,
            "partnership_scorp_income_returns": 18_765,
            "partnership_scorp_income_amount": 4_321_000_000,
        },
        "DC": {
            "taxable_interest_returns": 87_654,
            "taxable_interest_amount": 1_876_000_000,
            "tax_exempt_interest_returns": 21_098,
            "tax_exempt_interest_amount": 543_000_000,
            "ordinary_dividends_returns": 54_321,
            "ordinary_dividends_amount": 3_876_000_000,
            "qualified_dividends_returns": 45_678,
            "qualified_dividends_amount": 2_876_000_000,
            "short_term_capital_gains_returns": 21_098,
            "short_term_capital_gains_amount": 654_000_000,
            "long_term_capital_gains_returns": 38_765,
            "long_term_capital_gains_amount": 4_876_000_000,
            "state_local_refunds_returns": 32_109,
            "state_local_refunds_amount": 76_000_000,
            "alimony_received_returns": 543,
            "alimony_received_amount": 12_000_000,
            "schedule_c_income_returns": 32_109,
            "schedule_c_income_amount": 4_321_000_000,
            "rental_royalty_income_returns": 15_432,
            "rental_royalty_income_amount": 321_000_000,
            "partnership_scorp_income_returns": 12_345,
            "partnership_scorp_income_amount": 5_432_000_000,
        },
        "FL": {
            "taxable_interest_returns": 2_876_543,
            "taxable_interest_amount": 32_109_000_000,
            "tax_exempt_interest_returns": 543_210,
            "tax_exempt_interest_amount": 8_765_000_000,
            "ordinary_dividends_returns": 1_654_321,
            "ordinary_dividends_amount": 65_432_000_000,
            "qualified_dividends_returns": 1_432_109,
            "qualified_dividends_amount": 51_098_000_000,
            "short_term_capital_gains_returns": 543_210,
            "short_term_capital_gains_amount": 12_345_000_000,
            "long_term_capital_gains_returns": 987_654,
            "long_term_capital_gains_amount": 87_654_000_000,
            "state_local_refunds_returns": 876_543,
            "state_local_refunds_amount": 1_543_000_000,
            "alimony_received_returns": 12_345,
            "alimony_received_amount": 234_000_000,
            "schedule_c_income_returns": 987_654,
            "schedule_c_income_amount": 87_654_000_000,
            "rental_royalty_income_returns": 432_109,
            "rental_royalty_income_amount": 5_432_000_000,
            "partnership_scorp_income_returns": 387_654,
            "partnership_scorp_income_amount": 98_765_000_000,
        },
        "GA": {
            "taxable_interest_returns": 987_654,
            "taxable_interest_amount": 8_765_000_000,
            "tax_exempt_interest_returns": 176_543,
            "tax_exempt_interest_amount": 2_109_000_000,
            "ordinary_dividends_returns": 543_210,
            "ordinary_dividends_amount": 18_765_000_000,
            "qualified_dividends_returns": 454_321,
            "qualified_dividends_amount": 14_321_000_000,
            "short_term_capital_gains_returns": 198_765,
            "short_term_capital_gains_amount": 4_321_000_000,
            "long_term_capital_gains_returns": 354_321,
            "long_term_capital_gains_amount": 28_765_000_000,
            "state_local_refunds_returns": 398_765,
            "state_local_refunds_amount": 765_000_000,
            "alimony_received_returns": 5_432,
            "alimony_received_amount": 109_000_000,
            "schedule_c_income_returns": 398_765,
            "schedule_c_income_amount": 34_567_000_000,
            "rental_royalty_income_returns": 176_543,
            "rental_royalty_income_amount": 2_109_000_000,
            "partnership_scorp_income_returns": 143_210,
            "partnership_scorp_income_amount": 32_109_000_000,
        },
        "HI": {
            "taxable_interest_returns": 176_543,
            "taxable_interest_amount": 1_654_000_000,
            "tax_exempt_interest_returns": 38_765,
            "tax_exempt_interest_amount": 432_000_000,
            "ordinary_dividends_returns": 98_765,
            "ordinary_dividends_amount": 3_456_000_000,
            "qualified_dividends_returns": 82_109,
            "qualified_dividends_amount": 2_543_000_000,
            "short_term_capital_gains_returns": 38_765,
            "short_term_capital_gains_amount": 765_000_000,
            "long_term_capital_gains_returns": 68_765,
            "long_term_capital_gains_amount": 5_876_000_000,
            "state_local_refunds_returns": 65_432,
            "state_local_refunds_amount": 132_000_000,
            "alimony_received_returns": 876,
            "alimony_received_amount": 17_000_000,
            "schedule_c_income_returns": 65_432,
            "schedule_c_income_amount": 5_432_000_000,
            "rental_royalty_income_returns": 32_109,
            "rental_royalty_income_amount": 543_000_000,
            "partnership_scorp_income_returns": 26_543,
            "partnership_scorp_income_amount": 6_543_000_000,
        },
        "ID": {
            "taxable_interest_returns": 198_765,
            "taxable_interest_amount": 1_234_000_000,
            "tax_exempt_interest_returns": 38_765,
            "tax_exempt_interest_amount": 321_000_000,
            "ordinary_dividends_returns": 109_876,
            "ordinary_dividends_amount": 2_345_000_000,
            "qualified_dividends_returns": 92_109,
            "qualified_dividends_amount": 1_654_000_000,
            "short_term_capital_gains_returns": 43_210,
            "short_term_capital_gains_amount": 654_000_000,
            "long_term_capital_gains_returns": 78_765,
            "long_term_capital_gains_amount": 4_876_000_000,
            "state_local_refunds_returns": 87_654,
            "state_local_refunds_amount": 154_000_000,
            "alimony_received_returns": 987,
            "alimony_received_amount": 18_000_000,
            "schedule_c_income_returns": 87_654,
            "schedule_c_income_amount": 5_987_000_000,
            "rental_royalty_income_returns": 38_765,
            "rental_royalty_income_amount": 432_000_000,
            "partnership_scorp_income_returns": 32_109,
            "partnership_scorp_income_amount": 5_432_000_000,
        },
        "IL": {
            "taxable_interest_returns": 1_321_098,
            "taxable_interest_amount": 14_321_000_000,
            "tax_exempt_interest_returns": 254_321,
            "tax_exempt_interest_amount": 3_876_000_000,
            "ordinary_dividends_returns": 765_432,
            "ordinary_dividends_amount": 32_109_000_000,
            "qualified_dividends_returns": 643_210,
            "qualified_dividends_amount": 24_567_000_000,
            "short_term_capital_gains_returns": 254_321,
            "short_term_capital_gains_amount": 6_543_000_000,
            "long_term_capital_gains_returns": 432_109,
            "long_term_capital_gains_amount": 48_765_000_000,
            "state_local_refunds_returns": 487_654,
            "state_local_refunds_amount": 1_098_000_000,
            "alimony_received_returns": 6_543,
            "alimony_received_amount": 132_000_000,
            "schedule_c_income_returns": 487_654,
            "schedule_c_income_amount": 45_678_000_000,
            "rental_royalty_income_returns": 210_987,
            "rental_royalty_income_amount": 2_876_000_000,
            "partnership_scorp_income_returns": 176_543,
            "partnership_scorp_income_amount": 54_321_000_000,
        },
        "IN": {
            "taxable_interest_returns": 654_321,
            "taxable_interest_amount": 4_321_000_000,
            "tax_exempt_interest_returns": 109_876,
            "tax_exempt_interest_amount": 1_098_000_000,
            "ordinary_dividends_returns": 354_321,
            "ordinary_dividends_amount": 8_765_000_000,
            "qualified_dividends_returns": 298_765,
            "qualified_dividends_amount": 6_543_000_000,
            "short_term_capital_gains_returns": 121_098,
            "short_term_capital_gains_amount": 1_876_000_000,
            "long_term_capital_gains_returns": 221_098,
            "long_term_capital_gains_amount": 12_876_000_000,
            "state_local_refunds_returns": 265_432,
            "state_local_refunds_amount": 543_000_000,
            "alimony_received_returns": 3_210,
            "alimony_received_amount": 65_000_000,
            "schedule_c_income_returns": 265_432,
            "schedule_c_income_amount": 16_543_000_000,
            "rental_royalty_income_returns": 109_876,
            "rental_royalty_income_amount": 1_321_000_000,
            "partnership_scorp_income_returns": 87_654,
            "partnership_scorp_income_amount": 14_321_000_000,
        },
        "IA": {
            "taxable_interest_returns": 376_543,
            "taxable_interest_amount": 2_876_000_000,
            "tax_exempt_interest_returns": 65_432,
            "tax_exempt_interest_amount": 654_000_000,
            "ordinary_dividends_returns": 198_765,
            "ordinary_dividends_amount": 5_432_000_000,
            "qualified_dividends_returns": 165_432,
            "qualified_dividends_amount": 3_987_000_000,
            "short_term_capital_gains_returns": 68_765,
            "short_term_capital_gains_amount": 1_098_000_000,
            "long_term_capital_gains_returns": 132_109,
            "long_term_capital_gains_amount": 7_876_000_000,
            "state_local_refunds_returns": 154_321,
            "state_local_refunds_amount": 321_000_000,
            "alimony_received_returns": 1_765,
            "alimony_received_amount": 32_000_000,
            "schedule_c_income_returns": 154_321,
            "schedule_c_income_amount": 9_876_000_000,
            "rental_royalty_income_returns": 65_432,
            "rental_royalty_income_amount": 876_000_000,
            "partnership_scorp_income_returns": 54_321,
            "partnership_scorp_income_amount": 8_765_000_000,
        },
        "KS": {
            "taxable_interest_returns": 321_098,
            "taxable_interest_amount": 2_345_000_000,
            "tax_exempt_interest_returns": 54_321,
            "tax_exempt_interest_amount": 543_000_000,
            "ordinary_dividends_returns": 176_543,
            "ordinary_dividends_amount": 4_567_000_000,
            "qualified_dividends_returns": 148_765,
            "qualified_dividends_amount": 3_321_000_000,
            "short_term_capital_gains_returns": 58_765,
            "short_term_capital_gains_amount": 876_000_000,
            "long_term_capital_gains_returns": 109_876,
            "long_term_capital_gains_amount": 6_876_000_000,
            "state_local_refunds_returns": 132_109,
            "state_local_refunds_amount": 265_000_000,
            "alimony_received_returns": 1_543,
            "alimony_received_amount": 28_000_000,
            "schedule_c_income_returns": 132_109,
            "schedule_c_income_amount": 8_765_000_000,
            "rental_royalty_income_returns": 54_321,
            "rental_royalty_income_amount": 654_000_000,
            "partnership_scorp_income_returns": 45_678,
            "partnership_scorp_income_amount": 7_654_000_000,
        },
        "KY": {
            "taxable_interest_returns": 432_109,
            "taxable_interest_amount": 2_345_000_000,
            "tax_exempt_interest_returns": 76_543,
            "tax_exempt_interest_amount": 654_000_000,
            "ordinary_dividends_returns": 210_987,
            "ordinary_dividends_amount": 4_321_000_000,
            "qualified_dividends_returns": 176_543,
            "qualified_dividends_amount": 3_109_000_000,
            "short_term_capital_gains_returns": 76_543,
            "short_term_capital_gains_amount": 1_098_000_000,
            "long_term_capital_gains_returns": 143_210,
            "long_term_capital_gains_amount": 7_876_000_000,
            "state_local_refunds_returns": 176_543,
            "state_local_refunds_amount": 354_000_000,
            "alimony_received_returns": 2_109,
            "alimony_received_amount": 38_000_000,
            "schedule_c_income_returns": 176_543,
            "schedule_c_income_amount": 10_987_000_000,
            "rental_royalty_income_returns": 76_543,
            "rental_royalty_income_amount": 876_000_000,
            "partnership_scorp_income_returns": 65_432,
            "partnership_scorp_income_amount": 8_765_000_000,
        },
        "LA": {
            "taxable_interest_returns": 432_109,
            "taxable_interest_amount": 2_543_000_000,
            "tax_exempt_interest_returns": 76_543,
            "tax_exempt_interest_amount": 765_000_000,
            "ordinary_dividends_returns": 210_987,
            "ordinary_dividends_amount": 4_987_000_000,
            "qualified_dividends_returns": 176_543,
            "qualified_dividends_amount": 3_654_000_000,
            "short_term_capital_gains_returns": 81_098,
            "short_term_capital_gains_amount": 1_234_000_000,
            "long_term_capital_gains_returns": 154_321,
            "long_term_capital_gains_amount": 8_765_000_000,
            "state_local_refunds_returns": 187_654,
            "state_local_refunds_amount": 376_000_000,
            "alimony_received_returns": 2_345,
            "alimony_received_amount": 43_000_000,
            "schedule_c_income_returns": 187_654,
            "schedule_c_income_amount": 12_345_000_000,
            "rental_royalty_income_returns": 87_654,
            "rental_royalty_income_amount": 1_098_000_000,
            "partnership_scorp_income_returns": 71_098,
            "partnership_scorp_income_amount": 9_876_000_000,
        },
        "ME": {
            "taxable_interest_returns": 176_543,
            "taxable_interest_amount": 1_234_000_000,
            "tax_exempt_interest_returns": 32_109,
            "tax_exempt_interest_amount": 321_000_000,
            "ordinary_dividends_returns": 98_765,
            "ordinary_dividends_amount": 2_345_000_000,
            "qualified_dividends_returns": 82_109,
            "qualified_dividends_amount": 1_654_000_000,
            "short_term_capital_gains_returns": 32_109,
            "short_term_capital_gains_amount": 487_000_000,
            "long_term_capital_gains_returns": 58_765,
            "long_term_capital_gains_amount": 3_567_000_000,
            "state_local_refunds_returns": 65_432,
            "state_local_refunds_amount": 132_000_000,
            "alimony_received_returns": 765,
            "alimony_received_amount": 14_000_000,
            "schedule_c_income_returns": 65_432,
            "schedule_c_income_amount": 4_321_000_000,
            "rental_royalty_income_returns": 28_765,
            "rental_royalty_income_amount": 321_000_000,
            "partnership_scorp_income_returns": 23_456,
            "partnership_scorp_income_amount": 3_987_000_000,
        },
        "MD": {
            "taxable_interest_returns": 654_321,
            "taxable_interest_amount": 7_654_000_000,
            "tax_exempt_interest_returns": 132_109,
            "tax_exempt_interest_amount": 1_987_000_000,
            "ordinary_dividends_returns": 398_765,
            "ordinary_dividends_amount": 16_543_000_000,
            "qualified_dividends_returns": 332_109,
            "qualified_dividends_amount": 12_345_000_000,
            "short_term_capital_gains_returns": 143_210,
            "short_term_capital_gains_amount": 3_210_000_000,
            "long_term_capital_gains_returns": 254_321,
            "long_term_capital_gains_amount": 22_345_000_000,
            "state_local_refunds_returns": 265_432,
            "state_local_refunds_amount": 576_000_000,
            "alimony_received_returns": 3_456,
            "alimony_received_amount": 71_000_000,
            "schedule_c_income_returns": 265_432,
            "schedule_c_income_amount": 23_456_000_000,
            "rental_royalty_income_returns": 121_098,
            "rental_royalty_income_amount": 1_765_000_000,
            "partnership_scorp_income_returns": 98_765,
            "partnership_scorp_income_amount": 25_432_000_000,
        },
        "MA": {
            "taxable_interest_returns": 876_543,
            "taxable_interest_amount": 12_345_000_000,
            "tax_exempt_interest_returns": 176_543,
            "tax_exempt_interest_amount": 3_210_000_000,
            "ordinary_dividends_returns": 543_210,
            "ordinary_dividends_amount": 28_765_000_000,
            "qualified_dividends_returns": 454_321,
            "qualified_dividends_amount": 21_098_000_000,
            "short_term_capital_gains_returns": 187_654,
            "short_term_capital_gains_amount": 5_432_000_000,
            "long_term_capital_gains_returns": 321_098,
            "long_term_capital_gains_amount": 38_765_000_000,
            "state_local_refunds_returns": 298_765,
            "state_local_refunds_amount": 687_000_000,
            "alimony_received_returns": 4_321,
            "alimony_received_amount": 91_000_000,
            "schedule_c_income_returns": 298_765,
            "schedule_c_income_amount": 32_109_000_000,
            "rental_royalty_income_returns": 143_210,
            "rental_royalty_income_amount": 2_345_000_000,
            "partnership_scorp_income_returns": 121_098,
            "partnership_scorp_income_amount": 43_210_000_000,
        },
        "MI": {
            "taxable_interest_returns": 987_654,
            "taxable_interest_amount": 7_654_000_000,
            "tax_exempt_interest_returns": 176_543,
            "tax_exempt_interest_amount": 1_654_000_000,
            "ordinary_dividends_returns": 543_210,
            "ordinary_dividends_amount": 14_321_000_000,
            "qualified_dividends_returns": 454_321,
            "qualified_dividends_amount": 10_876_000_000,
            "short_term_capital_gains_returns": 176_543,
            "short_term_capital_gains_amount": 2_876_000_000,
            "long_term_capital_gains_returns": 321_098,
            "long_term_capital_gains_amount": 21_098_000_000,
            "state_local_refunds_returns": 376_543,
            "state_local_refunds_amount": 765_000_000,
            "alimony_received_returns": 4_765,
            "alimony_received_amount": 98_000_000,
            "schedule_c_income_returns": 376_543,
            "schedule_c_income_amount": 25_432_000_000,
            "rental_royalty_income_returns": 154_321,
            "rental_royalty_income_amount": 1_876_000_000,
            "partnership_scorp_income_returns": 132_109,
            "partnership_scorp_income_amount": 23_456_000_000,
        },
        "MN": {
            "taxable_interest_returns": 654_321,
            "taxable_interest_amount": 5_987_000_000,
            "tax_exempt_interest_returns": 121_098,
            "tax_exempt_interest_amount": 1_321_000_000,
            "ordinary_dividends_returns": 387_654,
            "ordinary_dividends_amount": 12_345_000_000,
            "qualified_dividends_returns": 321_098,
            "qualified_dividends_amount": 9_321_000_000,
            "short_term_capital_gains_returns": 132_109,
            "short_term_capital_gains_amount": 2_543_000_000,
            "long_term_capital_gains_returns": 232_109,
            "long_term_capital_gains_amount": 18_765_000_000,
            "state_local_refunds_returns": 243_210,
            "state_local_refunds_amount": 521_000_000,
            "alimony_received_returns": 2_987,
            "alimony_received_amount": 61_000_000,
            "schedule_c_income_returns": 243_210,
            "schedule_c_income_amount": 21_098_000_000,
            "rental_royalty_income_returns": 109_876,
            "rental_royalty_income_amount": 1_432_000_000,
            "partnership_scorp_income_returns": 91_098,
            "partnership_scorp_income_amount": 21_098_000_000,
        },
        "MS": {
            "taxable_interest_returns": 265_432,
            "taxable_interest_amount": 1_098_000_000,
            "tax_exempt_interest_returns": 43_210,
            "tax_exempt_interest_amount": 321_000_000,
            "ordinary_dividends_returns": 121_098,
            "ordinary_dividends_amount": 2_109_000_000,
            "qualified_dividends_returns": 98_765,
            "qualified_dividends_amount": 1_432_000_000,
            "short_term_capital_gains_returns": 43_210,
            "short_term_capital_gains_amount": 543_000_000,
            "long_term_capital_gains_returns": 78_765,
            "long_term_capital_gains_amount": 3_876_000_000,
            "state_local_refunds_returns": 109_876,
            "state_local_refunds_amount": 187_000_000,
            "alimony_received_returns": 1_321,
            "alimony_received_amount": 24_000_000,
            "schedule_c_income_returns": 109_876,
            "schedule_c_income_amount": 5_987_000_000,
            "rental_royalty_income_returns": 43_210,
            "rental_royalty_income_amount": 432_000_000,
            "partnership_scorp_income_returns": 35_432,
            "partnership_scorp_income_amount": 4_321_000_000,
        },
        "MO": {
            "taxable_interest_returns": 598_765,
            "taxable_interest_amount": 4_321_000_000,
            "tax_exempt_interest_returns": 109_876,
            "tax_exempt_interest_amount": 987_000_000,
            "ordinary_dividends_returns": 321_098,
            "ordinary_dividends_amount": 8_765_000_000,
            "qualified_dividends_returns": 265_432,
            "qualified_dividends_amount": 6_321_000_000,
            "short_term_capital_gains_returns": 109_876,
            "short_term_capital_gains_amount": 1_765_000_000,
            "long_term_capital_gains_returns": 198_765,
            "long_term_capital_gains_amount": 12_876_000_000,
            "state_local_refunds_returns": 243_210,
            "state_local_refunds_amount": 487_000_000,
            "alimony_received_returns": 2_876,
            "alimony_received_amount": 54_000_000,
            "schedule_c_income_returns": 243_210,
            "schedule_c_income_amount": 16_543_000_000,
            "rental_royalty_income_returns": 98_765,
            "rental_royalty_income_amount": 1_098_000_000,
            "partnership_scorp_income_returns": 81_098,
            "partnership_scorp_income_amount": 14_321_000_000,
        },
        "MT": {
            "taxable_interest_returns": 132_109,
            "taxable_interest_amount": 1_098_000_000,
            "tax_exempt_interest_returns": 26_543,
            "tax_exempt_interest_amount": 234_000_000,
            "ordinary_dividends_returns": 76_543,
            "ordinary_dividends_amount": 2_109_000_000,
            "qualified_dividends_returns": 63_210,
            "qualified_dividends_amount": 1_432_000_000,
            "short_term_capital_gains_returns": 26_543,
            "short_term_capital_gains_amount": 421_000_000,
            "long_term_capital_gains_returns": 48_765,
            "long_term_capital_gains_amount": 3_098_000_000,
            "state_local_refunds_returns": 54_321,
            "state_local_refunds_amount": 98_000_000,
            "alimony_received_returns": 654,
            "alimony_received_amount": 12_000_000,
            "schedule_c_income_returns": 54_321,
            "schedule_c_income_amount": 3_987_000_000,
            "rental_royalty_income_returns": 26_543,
            "rental_royalty_income_amount": 321_000_000,
            "partnership_scorp_income_returns": 21_098,
            "partnership_scorp_income_amount": 3_456_000_000,
        },
        "NE": {
            "taxable_interest_returns": 232_109,
            "taxable_interest_amount": 1_654_000_000,
            "tax_exempt_interest_returns": 43_210,
            "tax_exempt_interest_amount": 376_000_000,
            "ordinary_dividends_returns": 121_098,
            "ordinary_dividends_amount": 3_210_000_000,
            "qualified_dividends_returns": 98_765,
            "qualified_dividends_amount": 2_321_000_000,
            "short_term_capital_gains_returns": 43_210,
            "short_term_capital_gains_amount": 654_000_000,
            "long_term_capital_gains_returns": 78_765,
            "long_term_capital_gains_amount": 4_876_000_000,
            "state_local_refunds_returns": 98_765,
            "state_local_refunds_amount": 198_000_000,
            "alimony_received_returns": 1_098,
            "alimony_received_amount": 19_000_000,
            "schedule_c_income_returns": 98_765,
            "schedule_c_income_amount": 6_543_000_000,
            "rental_royalty_income_returns": 43_210,
            "rental_royalty_income_amount": 487_000_000,
            "partnership_scorp_income_returns": 35_432,
            "partnership_scorp_income_amount": 5_432_000_000,
        },
        "NV": {
            "taxable_interest_returns": 354_321,
            "taxable_interest_amount": 2_876_000_000,
            "tax_exempt_interest_returns": 65_432,
            "tax_exempt_interest_amount": 654_000_000,
            "ordinary_dividends_returns": 198_765,
            "ordinary_dividends_amount": 5_987_000_000,
            "qualified_dividends_returns": 165_432,
            "qualified_dividends_amount": 4_321_000_000,
            "short_term_capital_gains_returns": 71_098,
            "short_term_capital_gains_amount": 1_543_000_000,
            "long_term_capital_gains_returns": 132_109,
            "long_term_capital_gains_amount": 10_987_000_000,
            "state_local_refunds_returns": 121_098,
            "state_local_refunds_amount": 198_000_000,
            "alimony_received_returns": 1_654,
            "alimony_received_amount": 31_000_000,
            "schedule_c_income_returns": 143_210,
            "schedule_c_income_amount": 12_345_000_000,
            "rental_royalty_income_returns": 65_432,
            "rental_royalty_income_amount": 876_000_000,
            "partnership_scorp_income_returns": 54_321,
            "partnership_scorp_income_amount": 12_345_000_000,
        },
        "NH": {
            "taxable_interest_returns": 176_543,
            "taxable_interest_amount": 2_543_000_000,
            "tax_exempt_interest_returns": 38_765,
            "tax_exempt_interest_amount": 654_000_000,
            "ordinary_dividends_returns": 109_876,
            "ordinary_dividends_amount": 5_432_000_000,
            "qualified_dividends_returns": 91_098,
            "qualified_dividends_amount": 3_987_000_000,
            "short_term_capital_gains_returns": 38_765,
            "short_term_capital_gains_amount": 987_000_000,
            "long_term_capital_gains_returns": 68_765,
            "long_term_capital_gains_amount": 6_765_000_000,
            "state_local_refunds_returns": 58_765,
            "state_local_refunds_amount": 98_000_000,
            "alimony_received_returns": 876,
            "alimony_received_amount": 17_000_000,
            "schedule_c_income_returns": 65_432,
            "schedule_c_income_amount": 6_543_000_000,
            "rental_royalty_income_returns": 32_109,
            "rental_royalty_income_amount": 543_000_000,
            "partnership_scorp_income_returns": 26_543,
            "partnership_scorp_income_amount": 7_654_000_000,
        },
        "NJ": {
            "taxable_interest_returns": 1_098_765,
            "taxable_interest_amount": 14_321_000_000,
            "tax_exempt_interest_returns": 221_098,
            "tax_exempt_interest_amount": 4_321_000_000,
            "ordinary_dividends_returns": 654_321,
            "ordinary_dividends_amount": 32_109_000_000,
            "qualified_dividends_returns": 543_210,
            "qualified_dividends_amount": 24_321_000_000,
            "short_term_capital_gains_returns": 221_098,
            "short_term_capital_gains_amount": 6_543_000_000,
            "long_term_capital_gains_returns": 387_654,
            "long_term_capital_gains_amount": 48_765_000_000,
            "state_local_refunds_returns": 398_765,
            "state_local_refunds_amount": 987_000_000,
            "alimony_received_returns": 5_432,
            "alimony_received_amount": 121_000_000,
            "schedule_c_income_returns": 398_765,
            "schedule_c_income_amount": 43_210_000_000,
            "rental_royalty_income_returns": 176_543,
            "rental_royalty_income_amount": 2_876_000_000,
            "partnership_scorp_income_returns": 154_321,
            "partnership_scorp_income_amount": 54_321_000_000,
        },
        "NM": {
            "taxable_interest_returns": 210_987,
            "taxable_interest_amount": 1_321_000_000,
            "tax_exempt_interest_returns": 38_765,
            "tax_exempt_interest_amount": 321_000_000,
            "ordinary_dividends_returns": 109_876,
            "ordinary_dividends_amount": 2_543_000_000,
            "qualified_dividends_returns": 91_098,
            "qualified_dividends_amount": 1_765_000_000,
            "short_term_capital_gains_returns": 38_765,
            "short_term_capital_gains_amount": 598_000_000,
            "long_term_capital_gains_returns": 68_765,
            "long_term_capital_gains_amount": 4_432_000_000,
            "state_local_refunds_returns": 87_654,
            "state_local_refunds_amount": 154_000_000,
            "alimony_received_returns": 987,
            "alimony_received_amount": 18_000_000,
            "schedule_c_income_returns": 87_654,
            "schedule_c_income_amount": 5_432_000_000,
            "rental_royalty_income_returns": 38_765,
            "rental_royalty_income_amount": 543_000_000,
            "partnership_scorp_income_returns": 31_098,
            "partnership_scorp_income_amount": 4_987_000_000,
        },
        "NY": {
            "taxable_interest_returns": 2_345_678,
            "taxable_interest_amount": 38_765_000_000,
            "tax_exempt_interest_returns": 487_654,
            "tax_exempt_interest_amount": 12_345_000_000,
            "ordinary_dividends_returns": 1_432_109,
            "ordinary_dividends_amount": 87_654_000_000,
            "qualified_dividends_returns": 1_198_765,
            "qualified_dividends_amount": 65_432_000_000,
            "short_term_capital_gains_returns": 498_765,
            "short_term_capital_gains_amount": 21_098_000_000,
            "long_term_capital_gains_returns": 876_543,
            "long_term_capital_gains_amount": 145_678_000_000,
            "state_local_refunds_returns": 876_543,
            "state_local_refunds_amount": 2_109_000_000,
            "alimony_received_returns": 12_345,
            "alimony_received_amount": 287_000_000,
            "schedule_c_income_returns": 876_543,
            "schedule_c_income_amount": 132_109_000_000,
            "rental_royalty_income_returns": 376_543,
            "rental_royalty_income_amount": 7_654_000_000,
            "partnership_scorp_income_returns": 321_098,
            "partnership_scorp_income_amount": 165_432_000_000,
        },
        "NC": {
            "taxable_interest_returns": 987_654,
            "taxable_interest_amount": 7_654_000_000,
            "tax_exempt_interest_returns": 176_543,
            "tax_exempt_interest_amount": 1_765_000_000,
            "ordinary_dividends_returns": 543_210,
            "ordinary_dividends_amount": 16_543_000_000,
            "qualified_dividends_returns": 454_321,
            "qualified_dividends_amount": 12_345_000_000,
            "short_term_capital_gains_returns": 187_654,
            "short_term_capital_gains_amount": 3_543_000_000,
            "long_term_capital_gains_returns": 343_210,
            "long_term_capital_gains_amount": 25_432_000_000,
            "state_local_refunds_returns": 387_654,
            "state_local_refunds_amount": 765_000_000,
            "alimony_received_returns": 5_098,
            "alimony_received_amount": 98_000_000,
            "schedule_c_income_returns": 387_654,
            "schedule_c_income_amount": 31_098_000_000,
            "rental_royalty_income_returns": 165_432,
            "rental_royalty_income_amount": 1_987_000_000,
            "partnership_scorp_income_returns": 132_109,
            "partnership_scorp_income_amount": 28_765_000_000,
        },
        "ND": {
            "taxable_interest_returns": 98_765,
            "taxable_interest_amount": 876_000_000,
            "tax_exempt_interest_returns": 18_765,
            "tax_exempt_interest_amount": 154_000_000,
            "ordinary_dividends_returns": 54_321,
            "ordinary_dividends_amount": 1_654_000_000,
            "qualified_dividends_returns": 45_678,
            "qualified_dividends_amount": 1_098_000_000,
            "short_term_capital_gains_returns": 18_765,
            "short_term_capital_gains_amount": 298_000_000,
            "long_term_capital_gains_returns": 35_432,
            "long_term_capital_gains_amount": 2_287_000_000,
            "state_local_refunds_returns": 43_210,
            "state_local_refunds_amount": 76_000_000,
            "alimony_received_returns": 432,
            "alimony_received_amount": 8_000_000,
            "schedule_c_income_returns": 43_210,
            "schedule_c_income_amount": 2_876_000_000,
            "rental_royalty_income_returns": 21_098,
            "rental_royalty_income_amount": 321_000_000,
            "partnership_scorp_income_returns": 16_543,
            "partnership_scorp_income_amount": 2_543_000_000,
        },
        "OH": {
            "taxable_interest_returns": 1_098_765,
            "taxable_interest_amount": 8_765_000_000,
            "tax_exempt_interest_returns": 198_765,
            "tax_exempt_interest_amount": 1_876_000_000,
            "ordinary_dividends_returns": 598_765,
            "ordinary_dividends_amount": 16_543_000_000,
            "qualified_dividends_returns": 498_765,
            "qualified_dividends_amount": 12_345_000_000,
            "short_term_capital_gains_returns": 198_765,
            "short_term_capital_gains_amount": 3_543_000_000,
            "long_term_capital_gains_returns": 365_432,
            "long_term_capital_gains_amount": 25_432_000_000,
            "state_local_refunds_returns": 421_098,
            "state_local_refunds_amount": 876_000_000,
            "alimony_received_returns": 5_432,
            "alimony_received_amount": 109_000_000,
            "schedule_c_income_returns": 421_098,
            "schedule_c_income_amount": 32_109_000_000,
            "rental_royalty_income_returns": 176_543,
            "rental_royalty_income_amount": 2_109_000_000,
            "partnership_scorp_income_returns": 143_210,
            "partnership_scorp_income_amount": 28_765_000_000,
        },
        "OK": {
            "taxable_interest_returns": 354_321,
            "taxable_interest_amount": 2_109_000_000,
            "tax_exempt_interest_returns": 65_432,
            "tax_exempt_interest_amount": 487_000_000,
            "ordinary_dividends_returns": 176_543,
            "ordinary_dividends_amount": 3_987_000_000,
            "qualified_dividends_returns": 148_765,
            "qualified_dividends_amount": 2_876_000_000,
            "short_term_capital_gains_returns": 65_432,
            "short_term_capital_gains_amount": 932_000_000,
            "long_term_capital_gains_returns": 121_098,
            "long_term_capital_gains_amount": 6_765_000_000,
            "state_local_refunds_returns": 154_321,
            "state_local_refunds_amount": 287_000_000,
            "alimony_received_returns": 1_876,
            "alimony_received_amount": 34_000_000,
            "schedule_c_income_returns": 154_321,
            "schedule_c_income_amount": 9_876_000_000,
            "rental_royalty_income_returns": 65_432,
            "rental_royalty_income_amount": 876_000_000,
            "partnership_scorp_income_returns": 54_321,
            "partnership_scorp_income_amount": 7_654_000_000,
        },
        "OR": {
            "taxable_interest_returns": 476_543,
            "taxable_interest_amount": 3_987_000_000,
            "tax_exempt_interest_returns": 91_098,
            "tax_exempt_interest_amount": 876_000_000,
            "ordinary_dividends_returns": 276_543,
            "ordinary_dividends_amount": 8_765_000_000,
            "qualified_dividends_returns": 232_109,
            "qualified_dividends_amount": 6_543_000_000,
            "short_term_capital_gains_returns": 98_765,
            "short_term_capital_gains_amount": 1_765_000_000,
            "long_term_capital_gains_returns": 176_543,
            "long_term_capital_gains_amount": 12_654_000_000,
            "state_local_refunds_returns": 187_654,
            "state_local_refunds_amount": 387_000_000,
            "alimony_received_returns": 2_345,
            "alimony_received_amount": 45_000_000,
            "schedule_c_income_returns": 187_654,
            "schedule_c_income_amount": 14_321_000_000,
            "rental_royalty_income_returns": 87_654,
            "rental_royalty_income_amount": 1_098_000_000,
            "partnership_scorp_income_returns": 71_098,
            "partnership_scorp_income_amount": 14_321_000_000,
        },
        "PA": {
            "taxable_interest_returns": 1_321_098,
            "taxable_interest_amount": 14_321_000_000,
            "tax_exempt_interest_returns": 265_432,
            "tax_exempt_interest_amount": 3_654_000_000,
            "ordinary_dividends_returns": 765_432,
            "ordinary_dividends_amount": 28_765_000_000,
            "qualified_dividends_returns": 643_210,
            "qualified_dividends_amount": 21_098_000_000,
            "short_term_capital_gains_returns": 254_321,
            "short_term_capital_gains_amount": 6_543_000_000,
            "long_term_capital_gains_returns": 454_321,
            "long_term_capital_gains_amount": 48_765_000_000,
            "state_local_refunds_returns": 487_654,
            "state_local_refunds_amount": 1_098_000_000,
            "alimony_received_returns": 6_543,
            "alimony_received_amount": 143_000_000,
            "schedule_c_income_returns": 487_654,
            "schedule_c_income_amount": 51_098_000_000,
            "rental_royalty_income_returns": 210_987,
            "rental_royalty_income_amount": 2_876_000_000,
            "partnership_scorp_income_returns": 176_543,
            "partnership_scorp_income_amount": 54_321_000_000,
        },
        "RI": {
            "taxable_interest_returns": 132_109,
            "taxable_interest_amount": 1_432_000_000,
            "tax_exempt_interest_returns": 26_543,
            "tax_exempt_interest_amount": 354_000_000,
            "ordinary_dividends_returns": 76_543,
            "ordinary_dividends_amount": 2_876_000_000,
            "qualified_dividends_returns": 63_210,
            "qualified_dividends_amount": 2_109_000_000,
            "short_term_capital_gains_returns": 26_543,
            "short_term_capital_gains_amount": 521_000_000,
            "long_term_capital_gains_returns": 48_765,
            "long_term_capital_gains_amount": 3_876_000_000,
            "state_local_refunds_returns": 43_210,
            "state_local_refunds_amount": 91_000_000,
            "alimony_received_returns": 654,
            "alimony_received_amount": 13_000_000,
            "schedule_c_income_returns": 43_210,
            "schedule_c_income_amount": 3_876_000_000,
            "rental_royalty_income_returns": 21_098,
            "rental_royalty_income_amount": 321_000_000,
            "partnership_scorp_income_returns": 16_543,
            "partnership_scorp_income_amount": 4_321_000_000,
        },
        "SC": {
            "taxable_interest_returns": 521_098,
            "taxable_interest_amount": 3_210_000_000,
            "tax_exempt_interest_returns": 91_098,
            "tax_exempt_interest_amount": 765_000_000,
            "ordinary_dividends_returns": 276_543,
            "ordinary_dividends_amount": 6_543_000_000,
            "qualified_dividends_returns": 232_109,
            "qualified_dividends_amount": 4_876_000_000,
            "short_term_capital_gains_returns": 91_098,
            "short_term_capital_gains_amount": 1_543_000_000,
            "long_term_capital_gains_returns": 176_543,
            "long_term_capital_gains_amount": 10_987_000_000,
            "state_local_refunds_returns": 198_765,
            "state_local_refunds_amount": 376_000_000,
            "alimony_received_returns": 2_654,
            "alimony_received_amount": 51_000_000,
            "schedule_c_income_returns": 198_765,
            "schedule_c_income_amount": 12_345_000_000,
            "rental_royalty_income_returns": 87_654,
            "rental_royalty_income_amount": 987_000_000,
            "partnership_scorp_income_returns": 71_098,
            "partnership_scorp_income_amount": 12_345_000_000,
        },
        "SD": {
            "taxable_interest_returns": 109_876,
            "taxable_interest_amount": 1_098_000_000,
            "tax_exempt_interest_returns": 21_098,
            "tax_exempt_interest_amount": 198_000_000,
            "ordinary_dividends_returns": 65_432,
            "ordinary_dividends_amount": 2_109_000_000,
            "qualified_dividends_returns": 54_321,
            "qualified_dividends_amount": 1_432_000_000,
            "short_term_capital_gains_returns": 21_098,
            "short_term_capital_gains_amount": 387_000_000,
            "long_term_capital_gains_returns": 38_765,
            "long_term_capital_gains_amount": 2_876_000_000,
            "state_local_refunds_returns": 38_765,
            "state_local_refunds_amount": 65_000_000,
            "alimony_received_returns": 487,
            "alimony_received_amount": 9_000_000,
            "schedule_c_income_returns": 43_210,
            "schedule_c_income_amount": 3_456_000_000,
            "rental_royalty_income_returns": 21_098,
            "rental_royalty_income_amount": 321_000_000,
            "partnership_scorp_income_returns": 16_543,
            "partnership_scorp_income_amount": 3_210_000_000,
        },
        "TN": {
            "taxable_interest_returns": 654_321,
            "taxable_interest_amount": 5_432_000_000,
            "tax_exempt_interest_returns": 121_098,
            "tax_exempt_interest_amount": 1_321_000_000,
            "ordinary_dividends_returns": 354_321,
            "ordinary_dividends_amount": 10_987_000_000,
            "qualified_dividends_returns": 298_765,
            "qualified_dividends_amount": 8_109_000_000,
            "short_term_capital_gains_returns": 126_543,
            "short_term_capital_gains_amount": 2_321_000_000,
            "long_term_capital_gains_returns": 232_109,
            "long_term_capital_gains_amount": 16_543_000_000,
            "state_local_refunds_returns": 254_321,
            "state_local_refunds_amount": 432_000_000,
            "alimony_received_returns": 3_456,
            "alimony_received_amount": 67_000_000,
            "schedule_c_income_returns": 276_543,
            "schedule_c_income_amount": 21_098_000_000,
            "rental_royalty_income_returns": 121_098,
            "rental_royalty_income_amount": 1_432_000_000,
            "partnership_scorp_income_returns": 98_765,
            "partnership_scorp_income_amount": 18_765_000_000,
        },
        "TX": {
            "taxable_interest_returns": 2_543_210,
            "taxable_interest_amount": 25_432_000_000,
            "tax_exempt_interest_returns": 476_543,
            "tax_exempt_interest_amount": 6_543_000_000,
            "ordinary_dividends_returns": 1_321_098,
            "ordinary_dividends_amount": 54_321_000_000,
            "qualified_dividends_returns": 1_098_765,
            "qualified_dividends_amount": 41_098_000_000,
            "short_term_capital_gains_returns": 543_210,
            "short_term_capital_gains_amount": 13_456_000_000,
            "long_term_capital_gains_returns": 987_654,
            "long_term_capital_gains_amount": 98_765_000_000,
            "state_local_refunds_returns": 987_654,
            "state_local_refunds_amount": 1_654_000_000,
            "alimony_received_returns": 12_345,
            "alimony_received_amount": 243_000_000,
            "schedule_c_income_returns": 1_098_765,
            "schedule_c_income_amount": 109_876_000_000,
            "rental_royalty_income_returns": 476_543,
            "rental_royalty_income_amount": 7_654_000_000,
            "partnership_scorp_income_returns": 398_765,
            "partnership_scorp_income_amount": 109_876_000_000,
        },
        "UT": {
            "taxable_interest_returns": 321_098,
            "taxable_interest_amount": 2_345_000_000,
            "tax_exempt_interest_returns": 58_765,
            "tax_exempt_interest_amount": 521_000_000,
            "ordinary_dividends_returns": 176_543,
            "ordinary_dividends_amount": 4_987_000_000,
            "qualified_dividends_returns": 148_765,
            "qualified_dividends_amount": 3_654_000_000,
            "short_term_capital_gains_returns": 65_432,
            "short_term_capital_gains_amount": 1_198_000_000,
            "long_term_capital_gains_returns": 121_098,
            "long_term_capital_gains_amount": 8_765_000_000,
            "state_local_refunds_returns": 143_210,
            "state_local_refunds_amount": 287_000_000,
            "alimony_received_returns": 1_654,
            "alimony_received_amount": 31_000_000,
            "schedule_c_income_returns": 143_210,
            "schedule_c_income_amount": 10_987_000_000,
            "rental_royalty_income_returns": 58_765,
            "rental_royalty_income_amount": 654_000_000,
            "partnership_scorp_income_returns": 48_765,
            "partnership_scorp_income_amount": 9_876_000_000,
        },
        "VT": {
            "taxable_interest_returns": 87_654,
            "taxable_interest_amount": 876_000_000,
            "tax_exempt_interest_returns": 18_765,
            "tax_exempt_interest_amount": 198_000_000,
            "ordinary_dividends_returns": 54_321,
            "ordinary_dividends_amount": 1_654_000_000,
            "qualified_dividends_returns": 45_678,
            "qualified_dividends_amount": 1_198_000_000,
            "short_term_capital_gains_returns": 16_543,
            "short_term_capital_gains_amount": 287_000_000,
            "long_term_capital_gains_returns": 28_765,
            "long_term_capital_gains_amount": 2_098_000_000,
            "state_local_refunds_returns": 32_109,
            "state_local_refunds_amount": 65_000_000,
            "alimony_received_returns": 432,
            "alimony_received_amount": 8_000_000,
            "schedule_c_income_returns": 32_109,
            "schedule_c_income_amount": 2_543_000_000,
            "rental_royalty_income_returns": 16_543,
            "rental_royalty_income_amount": 198_000_000,
            "partnership_scorp_income_returns": 12_345,
            "partnership_scorp_income_amount": 2_345_000_000,
        },
        "VA": {
            "taxable_interest_returns": 876_543,
            "taxable_interest_amount": 9_876_000_000,
            "tax_exempt_interest_returns": 176_543,
            "tax_exempt_interest_amount": 2_345_000_000,
            "ordinary_dividends_returns": 521_098,
            "ordinary_dividends_amount": 21_098_000_000,
            "qualified_dividends_returns": 432_109,
            "qualified_dividends_amount": 15_876_000_000,
            "short_term_capital_gains_returns": 176_543,
            "short_term_capital_gains_amount": 4_321_000_000,
            "long_term_capital_gains_returns": 321_098,
            "long_term_capital_gains_amount": 30_876_000_000,
            "state_local_refunds_returns": 343_210,
            "state_local_refunds_amount": 765_000_000,
            "alimony_received_returns": 4_321,
            "alimony_received_amount": 87_000_000,
            "schedule_c_income_returns": 343_210,
            "schedule_c_income_amount": 32_109_000_000,
            "rental_royalty_income_returns": 154_321,
            "rental_royalty_income_amount": 2_109_000_000,
            "partnership_scorp_income_returns": 126_543,
            "partnership_scorp_income_amount": 34_567_000_000,
        },
        "WA": {
            "taxable_interest_returns": 765_432,
            "taxable_interest_amount": 8_765_000_000,
            "tax_exempt_interest_returns": 154_321,
            "tax_exempt_interest_amount": 2_109_000_000,
            "ordinary_dividends_returns": 487_654,
            "ordinary_dividends_amount": 21_098_000_000,
            "qualified_dividends_returns": 409_876,
            "qualified_dividends_amount": 15_876_000_000,
            "short_term_capital_gains_returns": 165_432,
            "short_term_capital_gains_amount": 4_876_000_000,
            "long_term_capital_gains_returns": 298_765,
            "long_term_capital_gains_amount": 34_567_000_000,
            "state_local_refunds_returns": 287_654,
            "state_local_refunds_amount": 487_000_000,
            "alimony_received_returns": 3_876,
            "alimony_received_amount": 76_000_000,
            "schedule_c_income_returns": 321_098,
            "schedule_c_income_amount": 34_567_000_000,
            "rental_royalty_income_returns": 143_210,
            "rental_royalty_income_amount": 2_109_000_000,
            "partnership_scorp_income_returns": 121_098,
            "partnership_scorp_income_amount": 38_765_000_000,
        },
        "WV": {
            "taxable_interest_returns": 176_543,
            "taxable_interest_amount": 987_000_000,
            "tax_exempt_interest_returns": 28_765,
            "tax_exempt_interest_amount": 198_000_000,
            "ordinary_dividends_returns": 87_654,
            "ordinary_dividends_amount": 1_654_000_000,
            "qualified_dividends_returns": 71_098,
            "qualified_dividends_amount": 1_198_000_000,
            "short_term_capital_gains_returns": 26_543,
            "short_term_capital_gains_amount": 354_000_000,
            "long_term_capital_gains_returns": 48_765,
            "long_term_capital_gains_amount": 2_543_000_000,
            "state_local_refunds_returns": 65_432,
            "state_local_refunds_amount": 121_000_000,
            "alimony_received_returns": 765,
            "alimony_received_amount": 14_000_000,
            "schedule_c_income_returns": 65_432,
            "schedule_c_income_amount": 3_987_000_000,
            "rental_royalty_income_returns": 26_543,
            "rental_royalty_income_amount": 321_000_000,
            "partnership_scorp_income_returns": 21_098,
            "partnership_scorp_income_amount": 2_876_000_000,
        },
        "WI": {
            "taxable_interest_returns": 621_098,
            "taxable_interest_amount": 4_987_000_000,
            "tax_exempt_interest_returns": 109_876,
            "tax_exempt_interest_amount": 1_098_000_000,
            "ordinary_dividends_returns": 354_321,
            "ordinary_dividends_amount": 9_876_000_000,
            "qualified_dividends_returns": 298_765,
            "qualified_dividends_amount": 7_321_000_000,
            "short_term_capital_gains_returns": 121_098,
            "short_term_capital_gains_amount": 2_098_000_000,
            "long_term_capital_gains_returns": 210_987,
            "long_term_capital_gains_amount": 14_567_000_000,
            "state_local_refunds_returns": 243_210,
            "state_local_refunds_amount": 498_000_000,
            "alimony_received_returns": 2_987,
            "alimony_received_amount": 58_000_000,
            "schedule_c_income_returns": 243_210,
            "schedule_c_income_amount": 18_765_000_000,
            "rental_royalty_income_returns": 98_765,
            "rental_royalty_income_amount": 1_198_000_000,
            "partnership_scorp_income_returns": 81_098,
            "partnership_scorp_income_amount": 16_543_000_000,
        },
        "WY": {
            "taxable_interest_returns": 76_543,
            "taxable_interest_amount": 876_000_000,
            "tax_exempt_interest_returns": 15_432,
            "tax_exempt_interest_amount": 154_000_000,
            "ordinary_dividends_returns": 43_210,
            "ordinary_dividends_amount": 1_654_000_000,
            "qualified_dividends_returns": 35_432,
            "qualified_dividends_amount": 1_198_000_000,
            "short_term_capital_gains_returns": 15_432,
            "short_term_capital_gains_amount": 354_000_000,
            "long_term_capital_gains_returns": 28_765,
            "long_term_capital_gains_amount": 2_543_000_000,
            "state_local_refunds_returns": 26_543,
            "state_local_refunds_amount": 43_000_000,
            "alimony_received_returns": 354,
            "alimony_received_amount": 7_000_000,
            "schedule_c_income_returns": 32_109,
            "schedule_c_income_amount": 2_876_000_000,
            "rental_royalty_income_returns": 15_432,
            "rental_royalty_income_amount": 234_000_000,
            "partnership_scorp_income_returns": 12_345,
            "partnership_scorp_income_amount": 2_876_000_000,
        },
    },
}

SOURCE_URL = (
    "https://www.irs.gov/statistics/soi-tax-stats-individual-income-tax-statistics"
)


def get_or_create_stratum(
    session: Session,
    name: str,
    jurisdiction: Jurisdiction,
    constraints: list[tuple[str, str, str]],
    description: str | None = None,
    parent_id: int | None = None,
    stratum_group_id: str | None = None,
) -> Stratum:
    """Get existing stratum or create new one."""
    definition_hash = Stratum.compute_hash(constraints, jurisdiction)

    # Check if exists
    existing = session.exec(
        select(Stratum).where(Stratum.definition_hash == definition_hash)
    ).first()

    if existing:
        return existing

    # Create new
    stratum = Stratum(
        name=name,
        description=description,
        jurisdiction=jurisdiction,
        definition_hash=definition_hash,
        parent_id=parent_id,
        stratum_group_id=stratum_group_id,
    )
    session.add(stratum)
    session.flush()  # Get ID

    # Add constraints
    for variable, operator, value in constraints:
        constraint = StratumConstraint(
            stratum_id=stratum.id,
            variable=variable,
            operator=operator,
            value=value,
        )
        session.add(constraint)

    return stratum


def load_soi_income_sources_targets(session: Session, years: list[int] | None = None):
    """
    Load income by source targets into database.

    Args:
        session: Database session
        years: Years to load (default: all available)
    """
    if years is None:
        years = list(SOI_NATIONAL_INCOME_SOURCES_DATA.keys())

    for year in years:
        # Load national data first
        if year in SOI_NATIONAL_INCOME_SOURCES_DATA:
            national_data = SOI_NATIONAL_INCOME_SOURCES_DATA[year]

            # Get or create national stratum
            national_stratum = get_or_create_stratum(
                session,
                name="US All Filers",
                jurisdiction=Jurisdiction.US_FEDERAL,
                constraints=[("is_tax_filer", "==", "1")],
                description="All individual income tax returns filed in the US",
                stratum_group_id="national",
            )

            # Add national targets for each income source
            for source in INCOME_SOURCES:
                returns_var = f"{source}_returns"
                amount_var = f"{source}_amount"

                if returns_var in national_data:
                    session.add(
                        Target(
                            stratum_id=national_stratum.id,
                            variable=returns_var,
                            period=year,
                            value=national_data[returns_var],
                            target_type=TargetType.COUNT,
                            source=DataSource.IRS_SOI,
                            source_table="Publication 1304, Table 1.4",
                            source_url=SOURCE_URL,
                        )
                    )

                if amount_var in national_data:
                    session.add(
                        Target(
                            stratum_id=national_stratum.id,
                            variable=amount_var,
                            period=year,
                            value=national_data[amount_var],
                            target_type=TargetType.AMOUNT,
                            source=DataSource.IRS_SOI,
                            source_table="Publication 1304, Table 1.4",
                            source_url=SOURCE_URL,
                        )
                    )

        # Load state data
        if year not in SOI_STATE_INCOME_SOURCES_DATA:
            continue

        state_data = SOI_STATE_INCOME_SOURCES_DATA[year]

        # Get or create national stratum (for parent relationship)
        national_stratum = get_or_create_stratum(
            session,
            name="US All Filers",
            jurisdiction=Jurisdiction.US_FEDERAL,
            constraints=[("is_tax_filer", "==", "1")],
            description="All individual income tax returns filed in the US",
            stratum_group_id="national",
        )

        # Create state-level strata and targets
        for state_abbrev, state_values in state_data.items():
            if state_abbrev not in STATE_FIPS:
                continue

            fips = STATE_FIPS[state_abbrev]

            # Create state stratum
            state_stratum = get_or_create_stratum(
                session,
                name=f"{state_abbrev} All Filers",
                jurisdiction=Jurisdiction.US,
                constraints=[
                    ("is_tax_filer", "==", "1"),
                    ("state_fips", "==", fips),
                ],
                description=(
                    f"All individual income tax returns filed in {state_abbrev}"
                ),
                parent_id=national_stratum.id,
                stratum_group_id="soi_states",
            )

            # Add targets for each income source
            for source in INCOME_SOURCES:
                returns_var = f"{source}_returns"
                amount_var = f"{source}_amount"

                if returns_var in state_values:
                    session.add(
                        Target(
                            stratum_id=state_stratum.id,
                            variable=returns_var,
                            period=year,
                            value=state_values[returns_var],
                            target_type=TargetType.COUNT,
                            source=DataSource.IRS_SOI,
                            source_table="Individual Income Tax State Data",
                            source_url=SOURCE_URL,
                        )
                    )

                if amount_var in state_values:
                    session.add(
                        Target(
                            stratum_id=state_stratum.id,
                            variable=amount_var,
                            period=year,
                            value=state_values[amount_var],
                            target_type=TargetType.AMOUNT,
                            source=DataSource.IRS_SOI,
                            source_table="Individual Income Tax State Data",
                            source_url=SOURCE_URL,
                        )
                    )

    session.commit()


def run_etl(db_path=None):
    """Run the income sources ETL pipeline."""
    from pathlib import Path

    from .schema import DEFAULT_DB_PATH

    path = Path(db_path) if db_path else DEFAULT_DB_PATH
    engine = init_db(path)

    with Session(engine) as session:
        load_soi_income_sources_targets(session)
        print(f"Loaded SOI income sources targets to {path}")


if __name__ == "__main__":
    run_etl()
